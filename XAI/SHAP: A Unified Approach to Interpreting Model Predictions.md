# SHAP: A Unified Approach to Interpreting Model Predictions

**著者**: Scott Lundberg, Su-In Lee  
**公開**: arXiv 2017（v2: 2017-11-25, NeurIPS 2017 掲載）  
**DOI**: 10.48550/arXiv.1705.07874  
**リンク**: [arXiv:1705.07874](https://arxiv.org/abs/1705.07874)

本論文は、個別予測に対する特徴量重要度を加法モデルで表す統一枠組み **SHAP (SHapley Additive exPlanations)** を提示します。ゲーム理論のシャープレイ値に基づき、望ましい公理（局所正確性・欠落性・一貫性）を同時に満たす唯一解であることを示し、既存の複数手法を統一するとともに高速化アルゴリズム（KernelSHAP/TreeSHAP/DeepSHAP）を提案します。

---

### 1. 新規性：この論文の貢献と既存研究との差分

- **加法的説明モデルの定式化**: 解釈可能表現上の線形加法モデルに制約したクラスを定義し、その中で満たすべき公理を明確化。
- **唯一性の理論**: 公理（Local accuracy, Missingness, Consistency）を満たす解はシャープレイ値に一意に対応することを証明。
- **手法の統一**: LIME, DeepLIFT など6手法を加法モデルの特例として整理し、差異を理論的に説明。
- **実用アルゴリズム**: KernelSHAP（汎用近似）、TreeSHAP（木モデルに対する厳密多項式時間）、DeepSHAP（深層への近似）を提示。

---

### 2. 理論/手法の核心：数式できっちり定式化

#### 2.1 加法的特徴アトリビューションモデル
- 解釈可能なバイナリ表現 \(x' \in \{0,1\}^{M}\)（\(M\): 特徴数）を用い、説明モデル \(g\) を
\[
 g(x') = \phi_0 + \sum_{i=1}^{M} \phi_i \, x'_i
\]
とする（\(\phi_i\) が特徴 \(i\) のアトリビューション）。元入力からの写像を \(h_x: \{0,1\}^{M} \to \mathbb{R}^d\) とし、\(x'\) でOFFの特徴は背景分布で補う。

- 望ましい公理：
  - **Local accuracy（局所正確性）**: \(f(x) = g(x')\)。
  - **Missingness（欠落性）**: \(x'_i = 0\) のとき \(\phi_i = 0\)。
  - **Consistency（一貫性）**: ある特徴の周辺的貢献が他の全ての入力に対して増すとき、そのアトリビューションは減少しない。

これらを満たす解は一意であり、以下のシャープレイ値に一致する。

#### 2.2 シャープレイ値（ゲーム理論）
特徴集合 \(N=\{1,\dots,M\}\)。\(S \subseteq N \setminus \{i\}\) に対し、\(i\) の周 marginal 貢献を
\[
 v(S \cup \{i\}) - v(S)
\]
とする。ここで \(v\) は価値関数。個別予測説明では、しばしば
\[
 v(S) \,=\, \mathbb{E}\bigl[ f(x) \mid x_S = x_S^{\text{obs}} \bigr]
\]
（条件付き期待, あるいは介入的期待）で定義する。すると、**シャープレイ値**は
\[
 \phi_i \,=\, \sum_{S \subseteq N \setminus \{i\}} \frac{|S|!\, (M-|S|-1)!}{M!}\,\Big( v(S \cup \{i\}) - v(S) \Big)
\]
で与えられる（全順序の一様平均）。\(\phi_0\) はベースライン \(\mathbb{E}[f(x)]\)。

#### 2.3 KernelSHAP（汎用近似：重み付き回帰）
シャープレイ値を、解釈可能入力の全組合せ上での**加法モデル係数回復**として解く。重み付き二乗誤差で
\[
 \min_{\phi_0,\,\boldsymbol{\phi}} \sum_{z' \in \{0,1\}^{M}} \pi_x(z')\,\Big( f\big(h_x(z')\big) - \phi_0 - \sum_{i} \phi_i z'_i \Big)^2,
\]
シャープレイ核
\[
 \pi_x(z') \,=\, \frac{M-1}{\binom{M}{|z'|}\, |z'|\,(M-|z'|)}
\]
を用いると、最適解が理論的にシャープレイ値に一致する。実装では全組合せの代わりにサンプリングし、L1等でスパース化する。

#### 2.4 TreeSHAP（決定木・勾配ブースティング向け厳密計算）
木モデルに対する \(v(S)\) を動的計画法で効率に評価し、シャープレイ値を**多項式時間**で厳密に計算。アンサンブルでは木ごとに計算して線形合成する。

#### 2.5 DeepSHAP（深層モデル向け近似）
DeepLIFT の線形性を活用して層ごとにシャープレイ値近似を合成。背景分布を用いた基準化により、出力の加法分解を近似的に満たす。

---

### 3. 「キモ」と重要性：本論文の核と影響
- **キモ**: 「加法的説明」クラスに対し、公理に基づく唯一解＝シャープレイ値という理論を打ち立て、汎用（KernelSHAP）と構造特化（Tree/DeepSHAP）の両輪で実用性を担保した点。
- **重要性/影響**: 手法間の乱立を収束させる統一観を提供し、産業界での標準的な説明手法として定着。ツール群（特にツリーモデル）の高速・厳密計算が普及を加速。

---

### 4. まとめ（要点）
- 加法モデル：\(g(x')=\phi_0+\sum_i \phi_i x'_i\)、公理（Local accuracy/Missingness/Consistency）。
- シャープレイ値：全サブセットにわたる周辺貢献の重み付き平均で一意。
- KernelSHAP：シャープレイ核を用いた重み付き回帰で近似的に解く。
- TreeSHAP：木モデルに対して厳密・多項式時間計算。
- DeepSHAP：DeepLIFT連携で深層モデルを近似的に説明。

参考: [arXiv:1705.07874](https://arxiv.org/abs/1705.07874)
