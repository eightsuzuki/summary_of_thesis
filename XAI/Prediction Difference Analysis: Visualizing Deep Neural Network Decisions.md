# Prediction Difference Analysis: Visualizing Deep Neural Network Decisions

**著者**: Luisa M. Zintgraf, Taco S. Cohen, Tameem Adel, Max Welling  
**公開**: ICLR 2017（arXiv 2017-02-15）  
**DOI**: 10.48550/arXiv.1702.04595  
**リンク**: [arXiv:1702.04595](https://arxiv.org/abs/1702.04595)

本論文は、特定入力に対するディープネットの予測根拠を、**予測差分（Prediction Difference）**で可視化する手法を提案します。画像分類では、ある領域を“文脈に従って”置換したときにクラススコアがどれだけ変化するかを測定し、クラスに対して**賛成/反対の証拠**となる領域を強調します。

---

### 1. 新規性：この論文の貢献
- **反事実的（counterfactual）な摂動**: 領域を単に黒塗りにせず、周囲文脈に条件づけて置換するため、分布外アーティファクトを低減。
- **賛成/反対のエビデンス分離**: 予測差分の符号で、クラスを支持（正）/反証（負）する領域を明確化。
- **医用画像など実応用**での有用性を実証（ImageNet/MRI など）。

---

### 2. 理論/手法の核心：数式できっちり定式化

#### 記法
- 入力画像を \(x\)、クラス \(c\) のスコア（ロジット/確率のいずれか）を \(f_c(x)\) とする。
- 画素/パッチのインデックス集合を \(S\)、それ以外を \(\bar{S}\) とする。
- 文脈条件付き生成分布 \(p(x_S\mid x_{\bar{S}})\) を仮定する（近傍からの統計推定など）。

#### 2.1 予測差分（Prediction Difference）
領域 \(S\) を文脈に従ってサンプル置換した入力 \(x^{(S)}\) に対し、
\[
\Delta_S^{(c)}(x) \,=\, f_c(x) \; - \; \mathbb{E}_{\tilde{x}_S \sim p(\cdot\mid x_{\bar{S}})} \big[ f_c(\,\tilde{x}_S,\; x_{\bar{S}}\,) \big].
\]
- \(\Delta_S^{(c)}(x) > 0\): クラス \(c\) への賛成（その領域が無くなるとスコアが下がる）
- \(\Delta_S^{(c)}(x) < 0\): 反対の証拠（無くすとスコアが上がる）

実装では \(M\) 回のサンプリング平均で近似：
\[
\mathbb{E}[\cdot] \;\approx\; \frac{1}{M}\sum_{m=1}^{M} f_c\big(\tilde{x}^{(m)}_S, x_{\bar{S}}\big).
\]

#### 2.2 ピクセル/ヒートマップ化
スライディングウィンドウで複数パッチ \(S\) を走査し、各画素 \(i\) に対して覆うパッチの差分を集約：
\[
\mathrm{Score}_i^{(c)} \;=\; \frac{1}{|\{S\ni i\}|} \sum_{S\ni i} w_S\, \Delta_S^{(c)}(x),
\]
\(w_S\) は窓中心重みなどの平滑化係数。正値は賛成、負値は反対エビデンスとして可視化（別カラーマップで表示）。

#### 2.3 条件付きサンプリングの近似
- **独立周辺化**: \(p(x_S\mid x_{\bar{S}}) \approx p(x_S)\) とする簡易近似。
- **文脈条件付き**: 近傍パッチからガウス/ガウシアン混合などで \(p(x_S\mid x_{\bar{S}})\) を推定してサンプル（自然画像の統計をより保つ）。

---

### 3. 実装ノート
- 窓サイズ/ストライド/サンプル回数 \(M\) が解像度と計算量を左右（例: \(S\in\{9\times 9, 15\times 15\}\), \(M\approx 5\sim 20\)）。
- スコア \(f_c\) はロジットの方が差分が線形的で安定なことが多い（確率は飽和に注意）。
- クラスごとに正負を分けて可視化し、賛成/反対の根拠を併記するのが実務的。

---

### 4. 「キモ」と重要性
- **キモ**: 「文脈に整合する反事実的置換」による予測差分で、局所摂動の妥当性と解釈性を両立。単なるマスキングより分布外アーティファクトが少ない。
- **重要性**: クラス賛成/反対の根拠を区別でき、医用画像などで誤診リスクの可視化に有用。勾配ベース手法やGrad-CAMと補完的。

---

### 5. まとめ（要点）
- 予測差分: \(\Delta_S^{(c)} = f_c(x) - \mathbb{E}_{p(x_S\mid x_{\bar{S}})}[f_c(\tilde{x}_S, x_{\bar{S}})]\)。
- 正は賛成、負は反対エビデンス。パッチ走査でヒートマップ化。
- 条件付きサンプリングで分布外摂動を回避。

参考: [arXiv:1702.04595](https://arxiv.org/abs/1702.04595)
